name: Deploy Smash Dragons to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job for static game
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Validate game files
        run: |
          echo "Checking required game files..."
          ls -la
          
          # Check that required files exist
          if [ ! -f "index.html" ]; then
            echo "Error: index.html not found"
            exit 1
          fi
          
          if [ ! -f "main.js" ]; then
            echo "Error: main.js not found"
            exit 1
          fi
          
          if [ ! -f "assets_data_uris.json" ]; then
            echo "Error: assets_data_uris.json not found"
            exit 1
          fi
          
          echo "All required files present âœ“"
          
          # Check file sizes to ensure assets loaded properly
          echo "File sizes:"
          ls -lh index.html main.js assets_data_uris.json
          
          # Validate JSON syntax
          echo "Validating JSON assets..."
          if ! cat assets_data_uris.json | python3 -m json.tool > /dev/null; then
            echo "Error: Invalid JSON in assets_data_uris.json"
            exit 1
          fi
          echo "JSON validation passed âœ“"

      - name: Create static site
        run: |
          echo "Preparing static site for deployment..."
          
          # Create a clean build directory
          mkdir -p _site
          
          # Copy all necessary files
          cp index.html _site/
          cp main.js _site/
          cp assets_data_uris.json _site/
          cp README.md _site/
          
          # Copy assets directory if it exists (fallback assets)
          if [ -d "assets" ]; then
            cp -r assets _site/
          fi
          
          # Create a .nojekyll file to bypass Jekyll processing
          touch _site/.nojekyll
          
          # Create a simple 404 page that redirects to the game
          cat > _site/404.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Smash Dragons - Page Not Found</title>
            <meta http-equiv="refresh" content="0; url=./">
          </head>
          <body>
            <h1>Redirecting to Smash Dragons...</h1>
            <p>If you are not redirected automatically, <a href="./">click here</a>.</p>
          </body>
          </html>
          EOF
          
          echo "Static site prepared successfully!"
          echo "Contents of _site:"
          ls -la _site/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    # Only deploy on push to main branch, not on PRs
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment success
        run: |
          echo "ðŸŽ® Smash Dragons deployed successfully!"
          echo "Game URL: ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "The enhanced game includes:"
          echo "âœ“ High-quality sprite assets"
          echo "âœ“ Enhanced gameplay mechanics"
          echo "âœ“ Mobile touch controls"
          echo "âœ“ Scoring system and multiple lives"
          echo "âœ“ Boss health system"
          echo "âœ“ Particle effects and visual polish"